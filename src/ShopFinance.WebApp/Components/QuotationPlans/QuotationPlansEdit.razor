@using ShopFinance.Application.Features.QuotationPlans.Commands
@using ShopFinance.Application.Features.QuotationPlans.DTOs
@using ShopFinance.Application.Features.QuotationPlans.Queries
@using ShopFinance.Application.Features.Phases.DTOs
@using ShopFinance.Application.Features.Phases.Queries
@using ShopFinance.Application.Services.Frequencies
@using ShopFinance.Application.Services.Frequencies.DTOs
@using ShopFinance.Application.Services.PaymentTerms
@using ShopFinance.Application.Services.PaymentTerms.DTOs
@using ShopFinance.Application.Services.InterestRates
@using ShopFinance.Application.Services.InterestRates.DTOs
@using ShopFinance.Application.Services.TaxRates
@using ShopFinance.Application.Services.TaxRates.DTOs

@using ShopFinance.Domain.Entities
@inject ISelectListService _selectListService
@inject IFrequencyService _frequencyService;
@inject IInterestRateService _interestRateService;
@inject ITaxRateService _taxRateService;
@inject IPaymentTermService _paymentTermService;


@if (_isLoading)
{
    <MudGrid>
        <MudItem xs="12" Class="text-center py-8">
            <MudProgressCircular Color="Color.Default" Indeterminate="true" />
            <MudText Typo="Typo.body1" Class="mt-2">Cargando plan de cotización...</MudText>
        </MudItem>
    </MudGrid>
}
else if (_model == null)
{
    <MudGrid>
        <MudItem xs="12" Class="text-center py-8">
            <MudIcon Icon="@Icons.Material.Filled.ErrorOutline" Size="Size.Large" Color="Color.Error" />
            <MudText Typo="Typo.h6" Class="mt-2">Plan de cotización no encontrado</MudText>
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Primary"
                       OnClick="NavigateToList"
                       StartIcon="@Icons.Material.Filled.ArrowBack"
                       Class="mt-4">
                Volver a la lista
            </MudButton>
        </MudItem>
    </MudGrid>
}
else
{
    <EditForm Model="_model" OnValidSubmit="HandleValidSubmit" id="editQuotationPlanForm">
        <FluentValidationValidator @ref="_fluentValidationValidator" />
        <DataAnnotationsValidator />
        <MudText Typo="Typo.subtitle1" Color="Color.Error">
            <ValidationSummary></ValidationSummary>
        </MudText>


        <FormSection Title="Información Básica">
            <MudGrid Spacing="2">
                <MudItem xs="12" sm="3">
                    <MudTextField @bind-Value="_model.Code"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense"
                                  Label="Codigo"
                                  For="@(() => _model.Code)"
                                  Disabled="_isSubmitting"
                                  HelperText="Codigo único">
                    </MudTextField>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="_model.PlanName"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense"
                                  Label="Nombre del Plan"
                                  For="@(() => _model.PlanName)"
                                  Disabled="_isSubmitting"
                                  HelperText="Nombre único del plan de cotización">
                    </MudTextField>
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudDatePicker Date="_model.InitialEffectiveDate"
                                   DateChanged="@OnChangeInitialEffectiveDate"
                                   Label="Fecha de Inicio Vigencia"
                                   Margin="Margin.Dense"
                                   Variant="Variant.Outlined"
                                   Disabled="_isSubmitting"
                                   PickerVariant="PickerVariant.Dialog" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudDatePicker
                                   Date="_model.FinalEffectiveDate"
                                   DateChanged="@OnChangeFinalEffectiveDate"
                                   Label="Fecha de Fin Vigencia"
                                   Margin="Margin.Dense"
                                   Variant="Variant.Outlined"
                                   Disabled="_isSubmitting"
                                   PickerVariant="PickerVariant.Dialog" />
                </MudItem>
                <MudItem xs="12">
                    <MudChip T="bool" Size="Size.Small"
                             Color="@(_model.Active ? Color.Success : Color.Error)"
                             Variant="Variant.Filled"
                             Class="mt-2">
                        @(_model.Active ? "Activo" : "Inactivo")
                    </MudChip>
                    <MudText Typo="Typo.caption" Color="Color.Default" Class="mt-1">
                        El plan estará activo desde @_model.InitialEffectiveDate?.ToString("dd/MM/yyyy") hasta @_model.FinalEffectiveDate?.ToString("dd/MM/yyyy")
                    </MudText>
                </MudItem>
            </MudGrid>
        </FormSection>
        <FormSection Title="Tasa de Impuesto">
            <MudGrid>
                <MudItem sm="6">
                    <MudSelect T="int?" @bind-Value="_model.TaxRateId"
                               Label="Seleccionar Tasa de Impuesto"
                               Variant="Variant.Outlined"
                               Margin="Margin.Dense"
                               Required="true"
                               Disabled="_isSubmitting">
                        @if (_taxRatesList != null)
                        {
                            @foreach (var taxRate in _taxRatesList.Where(tr => tr.IsActive))
                            {
                                <MudSelectItem T="int?" Value="@taxRate.Id">
                                    @taxRate.Name (@taxRate.Code) - @taxRate.Percentage.ToString("F2")%
                                </MudSelectItem>
                            }
                        }
                    </MudSelect>
                </MudItem>
            </MudGrid>
        </FormSection>
        <FormSection Title="Configuración de Fases">
            <MudText Typo="Typo.body2" Color="Color.Default" Class="mb-4">
                Seleccione las fases inicial y final que conformarán este plan de cotización.
            </MudText>
            <MudGrid>
                <MudItem xs="6">
                    <MudSelect T="int?"
                               @bind-Value="_model.PhaseIdInitial"
                               Label="Seleccionar Fase Inicial"
                               Variant="Variant.Outlined"
                               Margin="Margin.Dense"
                               HelperText="Seleccione la fase inicial del Plan">
                        @if (_phasesListInitial != null)
                        {
                            @foreach (var phase in _phasesListInitial)
                            {
                                <MudSelectItem T="int?" Value="@phase.Id">

                                    @phase.PhaseName

                                </MudSelectItem>
                            }
                        }

                    </MudSelect>
                </MudItem>
                <MudItem xs="6">
                    <MudSelect T="int?"
                               @bind-Value="_model.PhaseIdFinal"
                               Label="Seleccionar Fase Final"
                               Variant="Variant.Outlined"
                               Margin="Margin.Dense"
                               HelperText="Seleccione la fase final del Plan">
                        @if (_phasesListFinal != null)
                        {
                            @foreach (var phase in _phasesListFinal)
                            {
                                <MudSelectItem T="int?" Value="@phase.Id">@phase.PhaseName</MudSelectItem>
                            }
                        }
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" sm="12" md="12">

                    @if (_phasesList == null || !_phasesList.Any())
                    {
                        <MudAlert Severity="Severity.Info" Elevation="1">
                            <MudText>No hay fases disponibles</MudText>
                            Primero debe crear fases en el sistema para poder asignarlas al plan.
                        </MudAlert>
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Color="Color.Default" Class="mb-4">
                            Seleccione las fases restantes que formarán parte del plan de cotización y su estado (activo/inactivo).
                        </MudText>
                        <MudTable Items="_model.Phases" Dense="true" Bordered="true" Hover="true" Striped="true" Elevation="1">
                            <HeaderContent>
                                <MudTh Style="width: 20px">Orden</MudTh>
                                <MudTh>Fase</MudTh>
                                <MudTh>Estado</MudTh>
                                <MudTh>Activa</MudTh>
                            </HeaderContent>
                            <RowTemplate Context="phaseItem">
                                <MudTd DataLabel="Orden">
                                    @phaseItem.Order
                                </MudTd>
                                <MudTd DataLabel="Fase">
                                    <MudText Typo="Typo.body2">@phaseItem.PhaseName</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                        @if (phaseItem.IsInitial)
                                        {
                                            <MudBadge Color="Color.Success" Dot="true">Inicial</MudBadge>
                                        }
                                        @if (phaseItem.IsFinal)
                                        {
                                            <MudBadge Color="Color.Info" Dot="true" Class="ml-1">Final</MudBadge>
                                        }
                                        @if (phaseItem.Required)
                                        {
                                            <MudBadge Color="Color.Warning" Dot="true" Class="ml-1">Requerida</MudBadge>
                                        }
                                    </MudText>
                                </MudTd>
                                <MudTd DataLabel="Estado">
                                    @if (phaseItem.Active)
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Success" Variant="Variant.Filled">
                                            Activa
                                        </MudChip>
                                    }
                                    else
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Default" Variant="Variant.Outlined">
                                            Inactiva
                                        </MudChip>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Activa">
                                    <MudSwitch T="bool" @bind-Value="phaseItem.Active"
                                               ThumbIcon="@(phaseItem.Active==true ? Icons.Material.Filled.Done : Icons.Material.Filled.Close)"
                                               ThumbIconColor="@(phaseItem.Active==true ? Color.Success : Color.Error)"
                                               Disabled="@(_isSubmitting || phaseItem.Required)">
                                    </MudSwitch>

                                </MudTd>
                            </RowTemplate>
                            <PagerContent>
                                <MudTablePager />
                            </PagerContent>
                            <NoRecordsContent>
                                <MudText Align="Align.Center" Class="py-4">
                                    No hay fases asignadas al plan
                                </MudText>
                            </NoRecordsContent>
                        </MudTable>
                    }
                </MudItem>
            </MudGrid>

        </FormSection>

        <FormSection Title="Configuración de Frecuencias">
            <ToolBarContent>
                <MudToolBar>
                    <MudTooltip Text="Agregar Frecuencia">
                        <MudIconButton Icon="@Icons.Material.Filled.Add"
                                       Size="Size.Small"
                                       Color="Color.Primary"
                                       OnClick="OpenAddFrequencyDialog"
                                       Disabled="_isSubmitting" />
                    </MudTooltip>
                </MudToolBar>
            </ToolBarContent>
            <ChildContent>
                <MudGrid>
                    <MudItem xs="12">
                        @if (_frequenciesList == null || !_frequenciesList.Any())
                        {
                            <MudAlert Severity="Severity.Info" Elevation="1">
                                <MudText>No hay frecuencias disponibles</MudText>
                                Primero debe crear frecuencias en el sistema para poder asignarlas al plan.
                            </MudAlert>
                        }
                        else
                        {
                            <MudTable Items="_model.Frequencies" Dense="true" Bordered="true" Hover="true" Striped="true" Elevation="1">
                                <HeaderContent>
                                    <MudTh>Frecuencia</MudTh>
                                    <MudTh>Predeterminada</MudTh>
                                    <MudTh>Orden</MudTh>
                                    <MudTh>Estado</MudTh>
                                    <MudTh>Acciones</MudTh>
                                </HeaderContent>
                                <RowTemplate Context="frequencyItem">
                                    <MudTd DataLabel="Frecuencia">
                                        @{
                                            var frequency = _frequenciesList?.FirstOrDefault(f => f.Id == frequencyItem.FrequencyId);
                                            var frequencyName = frequency?.Name ?? "No encontrada";
                                        }
                                        <MudText Typo="Typo.body2">@frequencyName</MudText>
                                        @if (frequency != null)
                                        {
                                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                Cada @frequency.DaysInterval días
                                            </MudText>
                                        }
                                    </MudTd>
                                    <MudTd DataLabel="Predeterminada">
                                        <MudSwitch T="bool"
                                                   @bind-Value="frequencyItem.IsDefault"
                                                   Size="Size.Small"
                                                   Color="Color.Primary"
                                                   Disabled="@(_isSubmitting || !frequencyItem.Active)" />
                                    </MudTd>
                                    <MudTd DataLabel="Orden">
                                        <MudNumericField T="int"
                                                         @bind-Value="frequencyItem.Order"
                                                         Margin="Margin.Dense"
                                                         Variant="Variant.Outlined"
                                                         Min="1"
                                                         Max="100"
                                                         Disabled="_isSubmitting" />
                                    </MudTd>
                                    <MudTd DataLabel="Estado">
                                        <MudSwitch T="bool"
                                                   @bind-Value="frequencyItem.Active"
                                                   Size="Size.Small"
                                                   Color="Color.Primary"
                                                   Disabled="_isSubmitting" />
                                    </MudTd>
                                    <MudTd DataLabel="Acciones">
                                        <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                       Size="Size.Small"
                                                       Color="Color.Error"
                                                       OnClick="@(() => RemoveFrequency(frequencyItem))"
                                                       Disabled="_isSubmitting" />
                                    </MudTd>
                                </RowTemplate>
                                <NoRecordsContent>
                                    <MudText Align="Align.Center" Class="py-4">
                                        No hay frecuencias asignadas al plan. Agregue al menos una.
                                    </MudText>
                                </NoRecordsContent>
                            </MudTable>
                        }
                    </MudItem>
                </MudGrid>
            </ChildContent>
        </FormSection>

        <FormSection Title="Configuración de Plazos de Pago">
            <ToolBarContent>
                <MudToolBar>
                    <MudTooltip Text="Agregar Plazo">
                        <MudIconButton Icon="@Icons.Material.Filled.Add"
                                       Size="Size.Small"
                                       Color="Color.Primary"
                                       OnClick="OpenAddPaymentTermDialog"
                                       Disabled="_isSubmitting" />
                    </MudTooltip>
                </MudToolBar>
            </ToolBarContent>
            <ChildContent>
                <MudGrid>
                    <MudItem xs="12" sm="12" md="12">
                        @if (_paymentTermsList == null || !_paymentTermsList.Any() || _interestRatesList == null || !_interestRatesList.Any())
                        {
                            <MudAlert Severity="Severity.Info" Elevation="1">
                                <MudText>No hay plazos de pago o tasas de interés disponibles</MudText>
                                Primero debe crear plazos de pago y tasas de interés en el sistema.
                            </MudAlert>
                        }
                        else
                        {
                            <MudTable Items="_model.PaymentTerms" Dense="true" Bordered="true" Hover="true" Striped="true" Elevation="1">
                                <HeaderContent>
                                    <MudTh>Plazo</MudTh>
                                    <MudTh>Tasa de Interés</MudTh>
                                    <MudTh>Tasa Especial</MudTh>
                                    <MudTh>Promocional</MudTh>
                                    <MudTh>Orden</MudTh>
                                    <MudTh>Estado</MudTh>
                                    <MudTh>Acciones</MudTh>
                                </HeaderContent>
                                <RowTemplate Context="paymentTermItem">
                                    <MudTd DataLabel="Plazo">
                                        @{
                                            var paymentTerm = _paymentTermsList?.FirstOrDefault(pt => pt.Id == paymentTermItem.PaymentTermId);
                                            var paymentTermName = paymentTerm?.Name ?? "No encontrado";
                                        }
                                        <MudText Typo="Typo.body2">@paymentTermName</MudText>
                                        @if (paymentTerm != null)
                                        {
                                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                @paymentTerm.NumberOfPayments
                                            </MudText>
                                        }
                                    </MudTd>
                                    <MudTd DataLabel="Tasa de Interés">
                                        <MudSelect T="int?" @bind-Value="paymentTermItem.InterestRateId"
                                                   Variant="Variant.Outlined"
                                                   Margin="Margin.Dense"
                                                   Dense="true"
                                                   Disabled="_isSubmitting">
                                            @foreach (var interestRate in _interestRatesList.Where(ir => ir.IsActive))
                                            {
                                                <MudSelectItem T="int?" Value="@interestRate.Id">
                                                    @interestRate.RateName (@interestRate.AnnualPercentage.ToString("F2")%)
                                                </MudSelectItem>
                                            }
                                        </MudSelect>
                                    </MudTd>
                                    <MudTd DataLabel="Tasa Especial">
                                        <MudNumericField T="decimal?"
                                                         @bind-Value="paymentTermItem.SpecialRateOverride"
                                                         Margin="Margin.Dense"
                                                         Variant="Variant.Outlined"
                                                         Format="F2"
                                                         Adornment="Adornment.End"
                                                         AdornmentText="%"
                                                         Disabled="_isSubmitting || !paymentTermItem.Active" />
                                    </MudTd>
                                    <MudTd DataLabel="Promocional">
                                        <MudStack Row="true" Spacing="1">
                                            <MudSwitch T="bool"
                                                       @bind-Value="paymentTermItem.IsPromotional"
                                                       Size="Size.Small"
                                                       Color="Color.Primary"
                                                       Disabled="_isSubmitting || !paymentTermItem.Active" />
                                            @if (paymentTermItem.IsPromotional)
                                            {
                                                <MudDatePicker @bind-Date="paymentTermItem.PromotionEndDate"
                                                               Variant="Variant.Outlined"
                                                               Margin="Margin.Dense"
                                                               Disabled="_isSubmitting || !paymentTermItem.Active" />
                                            }
                                        </MudStack>
                                    </MudTd>
                                    <MudTd DataLabel="Orden">
                                        <MudNumericField T="int" @bind-Value="paymentTermItem.Order"
                                                         Variant="Variant.Outlined"
                                                         Margin="Margin.Dense"
                                                         Min="1"
                                                         Max="100"
                                                         Disabled="_isSubmitting" />
                                    </MudTd>
                                    <MudTd DataLabel="Estado">
                                        <MudSwitch T="bool"
                                                   @bind-Value="paymentTermItem.Active"
                                                   Size="Size.Small"
                                                   Color="Color.Primary"
                                                   Disabled="_isSubmitting" />
                                    </MudTd>
                                    <MudTd DataLabel="Acciones">
                                        <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                       Size="Size.Small"
                                                       Color="Color.Error"
                                                       OnClick="@(() => RemovePaymentTerm(paymentTermItem))"
                                                       Disabled="_isSubmitting" />
                                    </MudTd>
                                </RowTemplate>
                                <NoRecordsContent>
                                    <MudText Align="Align.Center" Class="py-4">
                                        No hay plazos de pago asignados al plan. Agregue al menos uno.
                                    </MudText>
                                </NoRecordsContent>
                            </MudTable>
                        }

                    </MudItem>
                </MudGrid>
            </ChildContent>
        </FormSection>
        <FormSection Title="Resumen">
            <MudGrid Spacing="2">
                <MudItem xs="12" sm="6">
                    <MudText Typo="Typo.subtitle1" Class="mb-2">Resumen</MudText>
                    <MudList T="string" Dense="true">
                        <MudListItem Icon="@Icons.Material.Filled.CheckCircle">
                            <MudText Typo="Typo.body2">Fases activas: @_activePhasesCount</MudText>
                        </MudListItem>
                        <MudListItem Icon="@Icons.Material.Filled.CalendarToday">
                            <MudText Typo="Typo.body2">Vigencia: @_model.InitialEffectiveDate?.ToString("dd/MM/yyyy") - @_model.FinalEffectiveDate?.ToString("dd/MM/yyyy")</MudText>
                        </MudListItem>
                        <MudListItem Icon="@Icons.Material.Filled.Info" IconColor="@(_model.Active ? Color.Success : Color.Warning)">
                            <MudText Typo="Typo.body2">Estado: @(_model.Active ? "Activo" : "Inactivo")</MudText>
                        </MudListItem>
                    </MudList>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudText Typo="Typo.caption" Color="Color.Default" Class="mb-2">
                        Los campos marcados con * son obligatorios.
                        El plan debe tener al menos una fase activa para poder ser utilizado.
                    </MudText>
                </MudItem>
                <MudItem xs="12">
                    <MudDivider Class="my-2" />
                    <MudStack Justify="Justify.FlexEnd" Spacing="2" Row="true">
                        <MudButton Variant="Variant.Outlined"
                                   Color="Color.Default"
                                   OnClick="NavigateToList"
                                   Disabled="_isSubmitting"
                                   StartIcon="@Icons.Material.Filled.ArrowBack">
                            Cancelar
                        </MudButton>
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   ButtonType="ButtonType.Submit"
                                   form="editQuotationPlanForm"
                                   Disabled="_isSubmitting || _model.Phases.Count == 0"
                                   StartIcon="@Icons.Material.Filled.Save"
                                   EndIcon="@(_isSubmitting ? Icons.Material.Filled.HourglassEmpty : null)">
                            @(_isSubmitting ? "Guardando..." : "Guardar Cambios")
                        </MudButton>
                    </MudStack>
                </MudItem>
            </MudGrid>

        </FormSection>

    </EditForm>
}

<!-- Dialogo para agregar frecuencia -->
<MudDialog Visible="_showAddFrequencyDialog" Options="_dialogOptions">
    <DialogContent>
        <MudText Typo="Typo.h6" Class="mb-3">Agregar Frecuencia al Plan</MudText>

        @if (_availableFrequencies == null || !_availableFrequencies.Any())
        {
            <MudAlert Severity="Severity.Info">
                No hay frecuencias disponibles para agregar. Todas las frecuencias ya están asignadas al plan.
            </MudAlert>
        }
        else
        {
            <MudSelect T="int?"
                       @bind-Value="_selectedFrequencyId"
                       Label="Seleccionar Frecuencia"
                       Variant="Variant.Outlined"
                       Margin="Margin.Dense"
                       HelperText="Seleccione una frecuencia para agregar al plan">
                @foreach (var frequency in _availableFrequencies)
                {
                    <MudSelectItem T="int?" Value="@frequency.Id">
                        @frequency.Name - Cada @frequency.DaysInterval días
                    </MudSelectItem>
                }
            </MudSelect>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CloseAddFrequencyDialog" Variant="Variant.Text">Cancelar</MudButton>
        <MudButton OnClick="ConfirmAddFrequency"
                   Variant="Variant.Filled"
                   Color="Color.Primary"
                   Disabled="_selectedFrequencyId == null">
            Agregar
        </MudButton>
    </DialogActions>
</MudDialog>

<!-- Dialogo para agregar plazo de pago -->
<MudDialog Visible="_showAddPaymentTermDialog" Options="_dialogOptions">
    <DialogContent>
        <MudText Typo="Typo.h6" Class="mb-3">Agregar Plazo de Pago al Plan</MudText>

        @if (_availablePaymentTermsList == null || !_availablePaymentTermsList.Any())
        {
            <MudAlert Severity="Severity.Info">
                No hay plazos de pago disponibles para agregar. Todos los plazos ya están asignados al plan.
            </MudAlert>
        }
        else
        {
            <MudSelect T="int?"
                       @bind-Value="_selectedPaymentTermId"
                       Label="Seleccionar Plazo de Pago"
                       Variant="Variant.Outlined"
                       Margin="Margin.Dense"
                       HelperText="Seleccione un plazo de pago para agregar al plan">
                @foreach (var paymentTerm in _availablePaymentTermsList)
                {
                    <MudSelectItem T="int?" Value="@paymentTerm.Id">
                        @paymentTerm.Name - @paymentTerm.NumberOfPayments cuotas
                    </MudSelectItem>
                }
            </MudSelect>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CloseAddPaymentTermDialog" Variant="Variant.Text">Cancelar</MudButton>
        <MudButton OnClick="ConfirmAddPaymentTerm"
                   Variant="Variant.Filled"
                   Color="Color.Primary"
                   Disabled="_selectedPaymentTermId == null">
            Agregar
        </MudButton>
    </DialogActions>
</MudDialog>

