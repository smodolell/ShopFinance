@attribute [Route(PageRoute.EditQuotationPlan + "/{Id:int?}")]
@attribute [AccessPoint(AppMenu.MenuConfiguracion, "Editar Plan de Cotización", AccessPointType.Page)]
@using ShopFinance.Application.Features.QuotationPlans.Commands
@using ShopFinance.Application.Features.QuotationPlans.DTOs
@using ShopFinance.Application.Features.Phases.DTOs
@using ShopFinance.Application.Features.QuotationPlans.Queries
@using ShopFinance.Application.Features.Phases.Queries
@using ShopFinance.Domain.Entities
@inject ISelectListService _selectListService

<PageHeader Title="Editar Plan de Cotización" Icon="@AppMenu.MenuConfiguracionIcon">
    <MudBreadcrumbs Items="_breadcrumbItems"></MudBreadcrumbs>
</PageHeader>

@if (_isLoading)
{
    <MudGrid>
        <MudItem xs="12" Class="text-center py-8">
            <MudProgressCircular Color="Color.Default" Indeterminate="true" />
            <MudText Typo="Typo.body1" Class="mt-2">Cargando plan de cotización...</MudText>
        </MudItem>
    </MudGrid>
}
else if (_model == null)
{
    <MudGrid>
        <MudItem xs="12" Class="text-center py-8">
            <MudIcon Icon="@Icons.Material.Filled.ErrorOutline" Size="Size.Large" Color="Color.Error" />
            <MudText Typo="Typo.h6" Class="mt-2">Plan de cotización no encontrado</MudText>
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Primary"
                       OnClick="NavigateToList"
                       StartIcon="@Icons.Material.Filled.ArrowBack"
                       Class="mt-4">
                Volver a la lista
            </MudButton>
        </MudItem>
    </MudGrid>
}
else
{
    <EditForm Model="_model" OnValidSubmit="HandleValidSubmit" id="editQuotationPlanForm">
        <FluentValidationValidator @ref="_fluentValidationValidator" />
        <DataAnnotationsValidator />

        <MudGrid Spacing="2">
            <!-- Información básica del plan -->
            <MudItem xs="12" sm="12" md="12">
                <MudPaper Elevation="1" Class="pa-4 mb-4">
                    <MudText Typo="Typo.h6" Class="mb-3">Información Básica</MudText>
                    <MudGrid Spacing="2">
                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="_model.PlanName"
                                          Variant="Variant.Outlined"
                                          Margin="Margin.Dense"
                                          Label="Nombre del Plan"
                                          For="@(() => _model.PlanName)"
                                          Disabled="_isSubmitting"
                                          HelperText="Nombre único del plan de cotización">
                            </MudTextField>
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <ReadOnlyField Value="@_quotationPlanId" Label="ID del Plan"></ReadOnlyField>
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudDatePicker @bind-Date="_initialEffectiveDate"
                                           Label="Fecha de Inicio Vigencia"
                                           Margin="Margin.Dense"
                                           Variant="Variant.Outlined"
                                           Disabled="_isSubmitting"
                                           PickerVariant="PickerVariant.Dialog" />
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudDatePicker @bind-Date="_finalEffectiveDate"
                                           Label="Fecha de Fin Vigencia"
                                           Margin="Margin.Dense"
                                           Variant="Variant.Outlined"
                                           Disabled="_isSubmitting"
                                           PickerVariant="PickerVariant.Dialog" />
                        </MudItem>
                        <MudItem xs="12">
                            <MudChip T="bool" Size="Size.Small"
                                     Color="@(_isActive ? Color.Success : Color.Error)"
                                     Variant="Variant.Filled"
                                     Class="mt-2">
                                @(_isActive ? "Activo" : "Inactivo")
                            </MudChip>
                            <MudText Typo="Typo.caption" Color="Color.Default" Class="mt-1">
                                El plan estará activo desde @_initialEffectiveDate?.ToString("dd/MM/yyyy") hasta @_finalEffectiveDate?.ToString("dd/MM/yyyy")
                            </MudText>
                        </MudItem>
                    </MudGrid>
                </MudPaper>
            </MudItem>

            <!-- Configuración de Fases -->
            <MudItem xs="12" sm="12" md="12">
                <MudPaper Elevation="1" Class="pa-4">
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-3">
                        <MudText Typo="Typo.h6">Configuración de Fases</MudText>
                        <MudTooltip Text="Agregar Fase">
                            <MudIconButton Icon="@Icons.Material.Filled.Add"
                                           Size="Size.Small"
                                           Color="Color.Primary"
                                           OnClick="AddPhase"
                                           Disabled="_isSubmitting" />
                        </MudTooltip>
                    </MudStack>

                    <MudText Typo="Typo.body2" Color="Color.Default" Class="mb-4">
                        Seleccione las fases que conformarán este plan de cotización. Las fases marcadas como activas estarán disponibles para su uso.
                    </MudText>

                    @if (_phasesList == null || !_phasesList.Any())
                    {
                        <MudAlert Severity="Severity.Info" Elevation="1">
                            <MudText>No hay fases disponibles</MudText>
                            Primero debe crear fases en el sistema para poder asignarlas al plan.
                        </MudAlert>
                    }
                    else
                    {
                        <MudTable Items="_phasesList" Dense="true" Hover="true" Striped="true" Elevation="1">
                            <HeaderContent>
                                <MudTh>Fase</MudTh>
                                <MudTh>Estado</MudTh>
                                <MudTh>Activa</MudTh>
                                <MudTh style="width: 100px;">Acciones</MudTh>
                            </HeaderContent>
                            <RowTemplate Context="phaseItem">
                                <MudTd DataLabel="Fase">
                                    <MudText Typo="Typo.body2">@phaseItem.PhaseName</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                        @if (phaseItem.IsInitial)
                                        {
                                            <MudBadge Color="Color.Success" Size="Size.Small">Inicial</MudBadge>
                                        }
                                        @if (phaseItem.IsFinal)
                                        {
                                            <MudBadge Color="Color.Info" Size="Size.Small" Class="ml-1">Final</MudBadge>
                                        }
                                        @if (phaseItem.Required)
                                        {
                                            <MudBadge Color="Color.Warning" Size="Size.Small" Class="ml-1">Requerida</MudBadge>
                                        }
                                    </MudText>
                                </MudTd>
                                <MudTd DataLabel="Estado">
                                    @if (phaseItem.Active)
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Success" Variant="Variant.Filled">
                                            Activa
                                        </MudChip>
                                    }
                                    else
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Default" Variant="Variant.Outlined">
                                            Inactiva
                                        </MudChip>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Activa">
                                    <MudSwitch T="bool" @bind-Checked="phaseItem.Active"
                                               Color="Color.Primary"
                                               Disabled="_isSubmitting" />
                                </MudTd>
                                <MudTd DataLabel="Acciones">
                                    <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                   Size="Size.Small"
                                                   Color="Color.Error"
                                                   OnClick="() => RemovePhase(phaseItem.Id)"
                                                   Disabled="_isSubmitting || _model.Phases.Count <= 1" />
                                </MudTd>
                            </RowTemplate>
                            <PagerContent>
                                <MudTablePager />
                            </PagerContent>
                            <NoRecordsContent>
                                <MudText Align="Align.Center" Class="py-4">
                                    No hay fases asignadas al plan
                                </MudText>
                            </NoRecordsContent>
                        </MudTable>
                    }
                </MudPaper>
            </MudItem>

            <!-- Resumen y acciones -->
            <MudItem xs="12">
                <MudPaper Elevation="1" Class="pa-4 mt-4">
                    <MudGrid Spacing="2">
                        <MudItem xs="12" sm="6">
                            <MudText Typo="Typo.subtitle1" Class="mb-2">Resumen</MudText>
                            <MudList T="string" Dense="true">
                                <MudListItem Icon="@Icons.Material.Filled.CheckCircle">

                                    <MudText Typo="Typo.body2">Fases activas: @_activePhasesCount</MudText>
                                </MudListItem>
                                <MudListItem Icon="@Icons.Material.Filled.CalendarToday">
                                    <MudText Typo="Typo.body2">Vigencia: @_initialEffectiveDate?.ToString("dd/MM/yyyy") - @_finalEffectiveDate?.ToString("dd/MM/yyyy")</MudText>
                                </MudListItem>
                                <MudListItem Icon="@Icons.Material.Filled.Info" IconColor="@(_isActive ? Color.Success : Color.Warning)">
                                    <MudText Typo="Typo.body2">Estado: @(_isActive ? "Activo" : "Inactivo")</MudText>
                                </MudListItem>
                            </MudList>
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudText Typo="Typo.caption" Color="Color.Default" Class="mb-2">
                                Los campos marcados con * son obligatorios.
                                El plan debe tener al menos una fase activa para poder ser utilizado.
                            </MudText>
                        </MudItem>
                        <MudItem xs="12">
                            <MudDivider Class="my-2" />
                            <MudStack Justify="Justify.FlexEnd" Spacing="2" Row="true">
                                <MudButton Variant="Variant.Outlined"
                                           Color="Color.Default"
                                           OnClick="NavigateToList"
                                           Disabled="_isSubmitting"
                                           StartIcon="@Icons.Material.Filled.ArrowBack">
                                    Cancelar
                                </MudButton>
                                <MudButton Variant="Variant.Filled"
                                           Color="Color.Primary"
                                           ButtonType="ButtonType.Submit"
                                           form="editQuotationPlanForm"
                                           Disabled="_isSubmitting || _model.Phases.Count == 0"
                                           StartIcon="@Icons.Material.Filled.Save"
                                           EndIcon="@(_isSubmitting ? Icons.Material.Filled.HourglassEmpty : null)">
                                    @(_isSubmitting ? "Guardando..." : "Guardar Cambios")
                                </MudButton>
                            </MudStack>
                        </MudItem>
                    </MudGrid>
                </MudPaper>
            </MudItem>
        </MudGrid>
    </EditForm>
}

<!-- Dialogo para agregar fase -->
<MudDialog @bind-IsVisible="_showAddPhaseDialog" MaxWidth="MaxWidth.Small">
    <DialogContent>
        <MudText Typo="Typo.h6" Class="mb-3">Agregar Fase al Plan</MudText>

        @if (_availablePhases == null || !_availablePhases.Any())
        {
            <MudAlert Severity="Severity.Info">
                No hay fases disponibles para agregar. Todas las fases ya están asignadas al plan.
            </MudAlert>
        }
        else
        {
            <MudSelect T="int?"
                       @bind-Value="_selectedPhaseId"
                       Label="Seleccionar Fase"
                       Variant="Variant.Outlined"
                       Margin="Margin.Dense"
                       HelperText="Seleccione una fase para agregar al plan">
                @foreach (var phase in _availablePhases)
                {
                    <MudSelectItem T="int?" Value="@phase.Id">
                        @phase.PhaseName
                        @if (phase.IsInitial)
                        {
                            <MudBadge Color="Color.Success" Size="Size.Small" Class="ml-1">Inicial</MudBadge>
                        }
                        @if (phase.IsFinal)
                        {<MudBadge Color="Color.Info" Size="Size.Small" Class="ml-1">Final</MudBadge>}
                    </MudSelectItem>
                }
            </MudSelect>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CloseAddPhaseDialog" Variant="Variant.Text">Cancelar</MudButton>
        <MudButton OnClick="ConfirmAddPhase"
                   Variant="Variant.Filled"
                   Color="Color.Primary"
                   Disabled="_selectedPhaseId == null">
            Agregar
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    #region Parameters
    [Parameter] public int Id { get; set; }
    #endregion

    #region Fields
    private CreateOrUpdateQuotationPlanCommand _model = new();
    private FluentValidationValidator? _fluentValidationValidator;
    private List<PhaseListItemDto>? _phasesList;
    private List<PhaseListItemDto>? _availablePhases;
    private bool _isLoading = true;
    private bool _isSubmitting = false;
    private bool _showAddPhaseDialog = false;
    private int? _selectedPhaseId = null;
    private int _quotationPlanId;
    private DateTime? _initialEffectiveDate;
    private DateTime? _finalEffectiveDate;
    private bool _isActive => _initialEffectiveDate.HasValue &&
                              _finalEffectiveDate.HasValue &&
                              DateTime.Today >= _initialEffectiveDate.Value &&
                              DateTime.Today <= _finalEffectiveDate.Value;
    private int _activePhasesCount => _model.Phases?.Count(p => p.Active) ?? 0;
    #endregion

    #region Breadcrumbs
    private readonly List<BreadcrumbItem> _breadcrumbItems = new()
{
        new BreadcrumbItem("Planes de Cotización", href: "/quotation-plans"),
        new BreadcrumbItem("Editar Plan", href: null, disabled: true)
    };
    #endregion

    #region Lifecycle Methods
    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    protected override async Task OnParametersSetAsync()
    {
        if (Id != _quotationPlanId)
        {
            await LoadData();
        }
    }
    #endregion

    #region Data Methods
    private async Task LoadData()
    {
        try
        {
            _isLoading = true;
            StateHasChanged();

            // Cargar lista de fases disponibles
            if (_phasesList == null)
            {
                _phasesList = await _queryMediator.QueryAsync(new GetPhasesListQuery());
            }

            // Cargar datos del plan existente
            var quotationPlanQuery = new GetQuotationPlanByIdQuery { Id = Id };
            var result = await _queryMediator.QueryAsync(quotationPlanQuery);

            if (result.IsSuccess && result.Value != null)
            {
                var quotationPlan = result.Value;
                _quotationPlanId = quotationPlan.Id;

                // Mapear al modelo de comando
                _model = new CreateOrUpdateQuotationPlanCommand
                {
                    QuotationPlanId = quotationPlan.Id,
                    PlanName = quotationPlan.PlanName,
                    InitialEffectiveDate = quotationPlan.InitialEffectiveDate,
                    FinalEffectiveDate = quotationPlan.FinalEffectiveDate,
                    Phases = quotationPlan.Phases.Select(p => new QuotationPlanPhaseCommand
                    {
                        PhaseId = p.PhaseId,
                        Active = p.Active
                    }).ToList()
                };

                // Configurar fechas para los pickers
                _initialEffectiveDate = _model.InitialEffectiveDate;
                _finalEffectiveDate = _model.FinalEffectiveDate;
            }
            else
            {
                _snackbarService.Add($"No se encontró el plan de cotización con ID: {Id}", Severity.Error);
                await Task.Delay(2000);
                NavigateToList();
            }
        }
        catch (Exception ex)
        {
            _snackbarService.Add($"Error al cargar datos: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private void UpdateAvailablePhases()
    {
        if (_phasesList == null) return;

        var assignedPhaseIds = _model.Phases.Select(p => p.PhaseId).ToList();
        _availablePhases = _phasesList
            .Where(p => !assignedPhaseIds.Contains(p.Id))
            .ToList();
    }
    #endregion

    #region UI Handlers
    private async Task HandleValidSubmit()
    {
        if (_isSubmitting) return;

        if (!await ValidateFormAsync())
            return;

        await UpdateQuotationPlanAsync();
    }

    private async Task<bool> ValidateFormAsync()
    {
        if (_fluentValidationValidator != null)
        {
            var isValid = await _fluentValidationValidator.ValidateAsync(options =>
            {
                options.IncludeAllRuleSets();
            });

            if (!isValid)
            {
                _snackbarService.Add("Por favor, corrige los errores del formulario", Severity.Warning);
                return false;
            }
        }

        // Validación adicional: al menos una fase activa
        if (_model.Phases.Count == 0)
        {
            _snackbarService.Add("Debe agregar al menos una fase al plan", Severity.Warning);
            return false;
        }

        if (!_model.Phases.Any(p => p.Active))
        {
            _snackbarService.Add("Debe tener al menos una fase activa", Severity.Warning);
            return false;
        }

        // Validar fechas
        if (!_initialEffectiveDate.HasValue || !_finalEffectiveDate.HasValue)
        {
            _snackbarService.Add("Debe especificar las fechas de vigencia", Severity.Warning);
            return false;
        }

        if (_finalEffectiveDate.Value <= _initialEffectiveDate.Value)
        {
            _snackbarService.Add("La fecha de fin debe ser posterior a la fecha de inicio", Severity.Warning);
            return false;
        }

        // Actualizar fechas en el modelo
        _model.InitialEffectiveDate = _initialEffectiveDate.Value;
        _model.FinalEffectiveDate = _finalEffectiveDate.Value;

        return true;
    }

    private void AddPhase()
    {
        UpdateAvailablePhases();

        if (_availablePhases == null || !_availablePhases.Any())
        {
            _snackbarService.Add("No hay fases disponibles para agregar", Severity.Info);
            return;
        }

        _selectedPhaseId = null;
        _showAddPhaseDialog = true;
    }

    private void CloseAddPhaseDialog()
    {
        _showAddPhaseDialog = false;
        _selectedPhaseId = null;
    }

    private void ConfirmAddPhase()
    {
        if (_selectedPhaseId.HasValue && _phasesList != null)
        {
            var selectedPhase = _phasesList.FirstOrDefault(p => p.Id == _selectedPhaseId.Value);
            if (selectedPhase != null)
            {
                // Agregar la fase al modelo
                _model.Phases.Add(new QuotationPlanPhaseCommand
                {
                    PhaseId = selectedPhase.Id,
                    Active = true // Por defecto activa
                });

                StateHasChanged();
            }
        }

        CloseAddPhaseDialog();
    }

    private void RemovePhase(int phaseId)
    {
        var phaseToRemove = _model.Phases.FirstOrDefault(p => p.PhaseId == phaseId);
        if (phaseToRemove != null)
        {
            _model.Phases.Remove(phaseToRemove);
            StateHasChanged();
        }
    }
    #endregion

    #region CRUD Operations
    private async Task UpdateQuotationPlanAsync()
    {
        _isSubmitting = true;
        StateHasChanged();

        try
        {
            var result = await _commandMediator.SendAsync(_model);

            if (result.IsSuccess)
            {
                _snackbarService.Add(
                    result.SuccessMessage ?? "Plan de cotización actualizado exitosamente",
                    Severity.Success);

                await Task.Delay(1000); // Pequeño delay para mostrar el mensaje
                NavigateToList();
            }
            else
            {
                var errorMessage = result.Errors?.FirstOrDefault() ?? "Error al actualizar el plan de cotización";
                _snackbarService.Add(errorMessage, Severity.Error);
            }
        }
        catch (Exception ex)
        {
            _snackbarService.Add($"Error inesperado: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSubmitting = false;
            StateHasChanged();
        }
    }

    private void NavigateToList()
    {
        _navManager.NavigateTo("/quotation-plans");
    }
    #endregion

    #region Helper Classes
    //public class PhaseListItemDto
    //{
    //    public int Id { get; set; }
    //    public string PhaseName { get; set; } = string.Empty;
    //    public bool IsInitial { get; set; }
    //    public bool IsFinal { get; set; }
    //    public bool Required { get; set; }
    //}
    #endregion
}