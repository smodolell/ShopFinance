@attribute [Route(PageRoute.NewProduct)]
@attribute [AccessPoint(AppMenu.MenuProject, "Nuevo Producto", AccessPointType.Page)]
@using ShopFinance.Application.Features.Products.Commands
@using ShopFinance.Application.Features.Products.DTOs
@inject ISelectListService _selectListService

<PageHeader Title="Nueva Producto" Icon="@AppMenu.MenuCatalogIcon">
    <MudBreadcrumbs Items="_breadcrumbItems"></MudBreadcrumbs>
</PageHeader>

<EditForm Model="_model" OnValidSubmit="HandleValidSubmit" id="createProductForm">
    <FluentValidationValidator @ref="_fluentValidationValidator" />
    <MudGrid Spacing="2">
        <MudItem xs="12" sm="6" md="4">
            <MudSelect Margin="Margin.Dense"
                       T="Guid"
                       @bind-Value="_model.WarehouseId"
                       For="@(() => _model.WarehouseId)"
                       Label="Almacen"
                       Required="true"
                       Variant="Variant.Outlined"
                       Disabled="_isSubmitting || _isLoading"
                       HelperText="Seleccione una Almacen">
                @if (_warehouses != null && _warehouses.Any())
                {
                    @foreach (var item in _warehouses)
                    {
                        <MudSelectItem T="Guid" Value="@(Guid.Parse(item.Value))">@item.Text</MudSelectItem>
                    }
                }
                else
                {
                    <MudSelectItem T="Guid" Value="Guid.Empty" Disabled="true">Cargando almacenes...</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
        <MudItem xs="12" sm="6" md="4">
            <MudSelect Margin="Margin.Dense"
                       T="int?"
                       @bind-Value="_model.CategoryId"
                       For="@(() => _model.CategoryId)"
                       Label="Categoría"
                       Required="true"
                       Variant="Variant.Outlined"
                       Disabled="_isSubmitting || _isLoading"
                       HelperText="Seleccione una categoría">
                @if (_categories != null && _categories.Any())
                {
                    @foreach (var item in _categories)
                    {
                        <MudSelectItem T="int?" Value="@(Convert.ToInt32(item.Value))">@item.Text</MudSelectItem>
                    }
                }
                else
                {
                    <MudSelectItem T="int?" Value="null" Disabled="true">Cargando categorías...</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
        <MudItem xs="12" sm="6" md="4">
            <MudTextField @bind-Value="_model.Code"
                          Variant="Variant.Outlined"
                          Margin="Margin.Dense"
                          Label="Código"
                          For="@(() => _model.Code)"
                          Disabled="_isSubmitting"
                          HelperText="Código único del producto (opcional)">
            </MudTextField>
        </MudItem>
        <MudItem xs="12" sm="6" md="4">
            <MudTextField @bind-Value="_model.CodeSku"
                          Variant="Variant.Outlined"
                          Margin="Margin.Dense"
                          Label="SKU"
                          For="@(() => _model.CodeSku)"
                          Disabled="_isSubmitting"
                          HelperText="Código único para inventario (ej: TSH-RED-M)">
            </MudTextField>
        </MudItem>
        <MudItem xs="12" sm="6" md="4">
            <MudEnumSelect TEnum="ProductState?"
                           @bind-Value="_model.State"
                           Margin="Margin.Dense"
                           Label="Estado"
                           Clearable="true"
                           Variant="Variant.Outlined"
                           Disabled="_isSubmitting" />
        </MudItem>
        <MudItem xs="12">
            <MudTextField @bind-Value="_model.Name"
                          Variant="Variant.Outlined"
                          Margin="Margin.Dense"
                          Label="Nombre *"
                          Required="true"
                          For="@(() => _model.Name)"
                          Disabled="_isSubmitting"
                          HelperText="Nombre descriptivo del producto">
            </MudTextField>
        </MudItem>
        <MudItem xs="12">
            <MudTextField @bind-Value="_model.Description"
                          Lines="3"
                          Variant="Variant.Outlined"
                          Margin="Margin.Dense"
                          Label="Descripción"
                          For="@(() => _model.Description)"
                          Disabled="_isSubmitting"
                          HelperText="Descripción detallada del producto">
            </MudTextField>
        </MudItem>
        <MudItem xs="12" sm="6" md="4">
            <MudNumericField @bind-Value="_model.CostPrice"
                             Variant="Variant.Outlined"
                             Margin="Margin.Dense"
                             Label="Precio de Costo"
                             Required="true"
                             For="@(() => _model.CostPrice)"
                             Disabled="_isSubmitting"
                             Adornment="Adornment.Start"
                             AdornmentIcon="@Icons.Material.Filled.AttachMoney"
                             AdornmentColor="Color.Default"
                             HelperText="Costo de adquisición">
            </MudNumericField>
        </MudItem>
        <MudItem xs="12" sm="6" md="4">
            <MudNumericField @bind-Value="_model.SalePrice"
                             Variant="Variant.Outlined"
                             Margin="Margin.Dense"
                             Label="Precio de Venta"
                             Required="true"
                             For="@(() => _model.SalePrice)"
                             Disabled="_isSubmitting"
                             Adornment="Adornment.Start"
                             AdornmentIcon="@Icons.Material.Filled.PointOfSale"
                             AdornmentColor="Color.Success"
                             HelperText="Precio de venta al público">
            </MudNumericField>
        </MudItem>
        <MudItem xs="12" sm="6" md="4">
            <MudNumericField @bind-Value="_model.Stock"
                             Variant="Variant.Outlined"
                             Margin="Margin.Dense"
                             Label="Stock Inicial"
                             Required="true"
                             For="@(() => _model.Stock)"
                             Disabled="_isSubmitting"
                             Min="0"
                             HelperText="Cantidad inicial en inventario">
            </MudNumericField>
        </MudItem>
        <MudItem xs="12" sm="6" md="4">
            <MudNumericField @bind-Value="_model.StockMin"
                             Variant="Variant.Outlined"
                             Margin="Margin.Dense"
                             Label="Stock Mínimo *"
                             Required="true"
                             For="@(() => _model.StockMin)"
                             Disabled="_isSubmitting"
                             Min="0"
                             HelperText="Nivel mínimo de inventario">
            </MudNumericField>
        </MudItem>
        <MudItem xs="12" sm="6" md="4">
            <MudNumericField @bind-Value="_model.StockMax"
                             Variant="Variant.Outlined"
                             Margin="Margin.Dense"
                             Label="Stock Máximo"
                             For="@(() => _model.StockMax)"
                             Disabled="_isSubmitting"
                             Min="0"
                             HelperText="Nivel máximo de inventario (opcional)">
            </MudNumericField>
        </MudItem>
        <MudItem xs="12">
            <MudText Typo="Typo.caption" Color="Color.Default">
                Los campos marcados con * son obligatorios
            </MudText>
        </MudItem>
        <MudItem xs="12">
            <MudStack Justify="Justify.FlexEnd" Spacing="2" Row="true">
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Default"
                           OnClick="NavigateToProducts"
                           Disabled="_isSubmitting"
                           StartIcon="@Icons.Material.Filled.ArrowBack">
                    Cancelar
                </MudButton>
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           ButtonType="ButtonType.Submit"
                           form="createProductForm"
                           Disabled="_isSubmitting"
                           StartIcon="@Icons.Material.Filled.Save"
                           EndIcon="@(_isSubmitting ? Icons.Material.Filled.HourglassEmpty : null)">
                    @(_isSubmitting ? "Creando..." : "Crear Producto")
                </MudButton>
            </MudStack>
        </MudItem>
    </MudGrid>
</EditForm>





@code {
    #region Fields
    private CreateProductWithWarehouseCommand _model = new();
    private FluentValidationValidator? _fluentValidationValidator;
    private List<SelectListItemDto>? _categories;
    private List<SelectListItemDto>? _warehouses;
    private bool _isSubmitting = false;
    private bool _isLoading = true;
    #endregion

    #region Breadcrumbs
    private readonly List<BreadcrumbItem> _breadcrumbItems = new()
    {
        new BreadcrumbItem("Productos", href: PageRoute.Products),
        new BreadcrumbItem("Nuevo Producto", href: null, disabled: true)
    };

    #endregion

    #region Lifecycle Methods
    protected override async Task OnInitializedAsync()
    {
        await LoadInitialData();
    }
    #endregion

    #region Data Methods
    private async Task LoadInitialData()
    {
        try
        {
            _isLoading = true;
            if (_categories == null)
            {
                _categories = await _selectListService.Categories();
            }
            if (_warehouses == null)
            {
                _warehouses = await _selectListService.Warehouses();
            }

            // Configuración inicial del modelo
            //_model.State = ProductState.Active;
            _model.Stock = 0;
            _model.StockMin = 0;
        }
        catch (Exception ex)
        {
            _snackbarService.Add($"Error al cargar datos iniciales: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }
    #endregion

    #region Event Handlers
    private async Task HandleValidSubmit()
    {
        if (_isSubmitting) return;

        if (!await ValidateFormAsync())
            return;

        await CreateProductAsync();
    }

    private async Task<bool> ValidateFormAsync()
    {
        if (_fluentValidationValidator != null)
        {
            var isValid = await _fluentValidationValidator.ValidateAsync(options =>
            {
                options.IncludeAllRuleSets();
            });

            if (!isValid)
            {
                _snackbarService.Add("Por favor, corrige los errores del formulario", Severity.Warning);
                return false;
            }
        }



        return true;
    }
    #endregion

    #region CRUD Operations
    private async Task CreateProductAsync()
    {
        _isSubmitting = true;

        try
        {
            var result = await _commandMediator.SendAsync(_model);

            if (result.IsSuccess)
            {
                _snackbarService.Add(result.SuccessMessage ?? "Producto creado exitosamente", Severity.Success);
                await Task.Delay(500); // Pequeño delay para mostrar el mensaje
                NavigateToProducts();
            }
            else
            {
                var errorMessage = result.Errors?.FirstOrDefault() ?? "Error al crear el producto";
                _snackbarService.Add(errorMessage, Severity.Error);
            }
        }
        catch (Exception ex)
        {
            _snackbarService.Add($"Error inesperado: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private void NavigateToProducts()
    {
        _navManager.NavigateTo("." + PageRoute.Products);
    }
    #endregion

}
