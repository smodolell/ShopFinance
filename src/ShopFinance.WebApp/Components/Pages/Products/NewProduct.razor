@attribute [Route(PageRoute.NewProduct)]
@attribute [AccessPoint(AppMenu.MenuProject, "Nuevo Producto", AccessPointType.Page)]
@using ShopFinance.Application.Features.Products.Commands
@using ShopFinance.Application.Features.Products.DTOs
@inject ISelectListService _selectListService

<PageHeader Title="Nueva Producto" Icon="@AppMenu.MenuProjectIcon">
    <MudBreadcrumbs Items="_items"></MudBreadcrumbs>
</PageHeader>

<EditForm Model="_model" OnValidSubmit="Create">
    <FluentValidationValidator @ref="_fluentValidationValidator" />
    <MudGrid>
        <MudItem xs="12" sm="6" md="3">
            <MudSelect Margin="Margin.Dense"
                       T="int?"
                       @bind-Value="_model.CategoryId"
                       For="@(() => _model.CategoryId)"
                       Label="Categoria" Variant="Variant.Outlined">
                @if (_listCatetory != null)
                {
                    @foreach (var item in _listCatetory)
                    {
                        <MudSelectItem T="int?" Value="@(Convert.ToInt32(item.Value))">@item.Text </MudSelectItem>
                    }
                }
            </MudSelect>
        </MudItem>
        <MudItem xs="12" sm="12" md="12">
            <MudTextField @bind-Value="_model.Name"
                          Variant="Variant.Outlined"
                          Margin="Margin.Dense"
                          Label="Nombre"
                          For="@(() => _model.Name)">
            </MudTextField>
        </MudItem>
        <MudItem xs="12" sm="12" md="12">
            <MudTextField @bind-Value="_model.Description"
                          Variant="Variant.Outlined"
                          Margin="Margin.Dense"
                          Label="Descripción"
                          For="@(() => _model.Description)">
            </MudTextField>
        </MudItem>
        <MudItem xs="12" sm="12" md="12">
            <MudNumericField @bind-Value="_model.SalePrice"
                             Variant="Variant.Outlined"
                             Margin="Margin.Dense"
                             Label="Precio de Venta"
                             For="@(() => _model.SalePrice)">
            </MudNumericField>

        </MudItem>
        <MudItem xs="12" sm="12" md="12">
            <MudNumericField @bind-Value="_model.CostPrice"
                             Variant="Variant.Outlined"
                             Margin="Margin.Dense"
                             Label="Precio de Costo"
                             For="@(() => _model.CostPrice)">
            </MudNumericField>
        </MudItem>
        <MudItem xs="12" sm="12" md="12">
            <MudNumericField @bind-Value="_model.Stock"
                             Variant="Variant.Outlined"
                             Margin="Margin.Dense"
                             Label="Stock"
                             For="@(() => _model.Stock)">
            </MudNumericField>
        </MudItem>
        <MudItem xs="12" sm="12" md="12">
            <MudNumericField @bind-Value="_model.StockMin"
                             Variant="Variant.Outlined"
                             Margin="Margin.Dense"
                             Label="Stock Mininimo"
                             For="@(() => _model.StockMin)">
            </MudNumericField>
        </MudItem>
        <MudItem xs="12" sm="12" md="12">
            <MudStack Justify="Justify.FlexEnd">
                <MudButton Variant="Variant.Filled"
                           ButtonType="ButtonType.Submit"
                           Color="Color.Primary"
                           Class="ml-auto">
                    Crear Producto
                </MudButton>
            </MudStack>
        </MudItem>
    </MudGrid>
</EditForm>





@code {

    private CreateProductCommand _model = new CreateProductCommand();
    private FluentValidationValidator? _fluentValidationValidator;
    private List<SelectListItemDto>? _listCatetory;

    protected override async Task OnInitializedAsync()
    {
        if (_listCatetory == null)
        {
            _listCatetory = await _selectListService.Categories();
        }

    }

    private async Task Create()
    {
        if (_model == null) return;

        var valid = await _fluentValidationValidator!.ValidateAsync();
        if (!valid) return;

        var result = await _commandMediator.SendAsync(_model);

        if (result.IsSuccess)
        {
            _snackbarService.Add(result.SuccessMessage, Severity.Success);
            _navManager.NavigateTo("." + PageRoute.Products);
        }
        else
        {
            _snackbarService.Add(result.Errors.FirstOrDefault() ?? "Error", Severity.Error);
        }

    }



    private List<BreadcrumbItem> _items = new List<BreadcrumbItem>
{
        new BreadcrumbItem("Products", href: ("." + PageRoute.Categories), icon: Icons.Material.Filled.Home),
        new BreadcrumbItem("Nuevo Producto", href: null, icon:AppMenu.MenuOperacionIcon,disabled:true)
    };
}
