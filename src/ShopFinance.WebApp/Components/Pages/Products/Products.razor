@attribute [Route(PageRoute.Products)]
@attribute [AccessPoint(AppMenu.MenuCatalog, "Productos")]
@using ShopFinance.Application.Features.Products.Commands
@using ShopFinance.Application.Features.Products.DTOs
@using ShopFinance.Application.Features.Products.Queries
@using ShopFinance.Domain.Enums

<PageHeader Title="Productos" Icon="@AppMenu.MenuCatalogIcon">
    <MudBreadcrumbs Items="_items"></MudBreadcrumbs>
</PageHeader>

@if (_filtersVisible)
{
    <MudExpansionPanels Outlined="true" Dense="true" Elevation="0">
        <MudExpansionPanel @bind-Expanded="_advancedSearchExpanded">
            <TitleContent>
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudIcon Icon="@Icons.Material.Filled.FilterAlt" Color="Color.Primary" Size="Size.Small" />
                    <MudText Typo="Typo.h6" Class="font-weight-medium">Filtros de búsqueda</MudText>
                </MudStack>
            </TitleContent>
            <ChildContent>
                <MudGrid Spacing="2">
                    <MudItem xs="12" sm="6" md="4">
                        <MudTextField @bind-Value="_filter.SearchText"
                                      Label="Buscar proyecto..."
                                      Variant="Variant.Outlined"
                                      Margin="Margin.Dense"
                                      Adornment="Adornment.Start"
                                      AdornmentIcon="@Icons.Material.Filled.Search" />
                    </MudItem>
                    <MudItem xs="12" sm="6" md="4">
                        <MudEnumSelect TEnum="ProductState?"
                                       @bind-Value="_filter.State"
                                       Margin="Margin.Dense"
                                       Label="Estado del proyecto"
                                       Clearable="true"
                                       Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" sm="12" md="4">
                        <MudDateRangePicker @bind-DateRange="_dateRange"
                                            Label="Fecha de creación"
                                            Margin="Margin.Dense"
                                            Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" sm="12" md="12">
                        <MudStack Row="true" Justify="Justify.FlexEnd">
                            <MudButton Variant="Variant.Text"
                                       Size="Size.Small"
                                       StartIcon="@Icons.Material.Filled.DeleteOutline"
                                       OnClick="ClearFilters">
                                Limpiar
                            </MudButton>
                            <MudButton Variant="Variant.Text"
                                       Color="Color.Default"
                                       Size="Size.Small"
                                       StartIcon="@Icons.Material.Filled.Search"
                                       OnClick="ApplyFilters">
                                Filtrar
                            </MudButton>
                        </MudStack>
                    </MudItem>
                </MudGrid>
            </ChildContent>
        </MudExpansionPanel>
    </MudExpansionPanels>


}

<MudDataGrid Outlined="true"
             Dense="true"
             Bordered="true"
             Class="mt-2"
             ServerData="GetTableData"
             FixedHeader="true"
             SortMode="SortMode.Single"
             @ref="dataGridRef"
             Loading="_loading"
             T="ProductListItemDto">
    <ToolBarContent>
        <MudSpacer></MudSpacer>
        <MudStack Row="true" AlignItems="AlignItems.End">
            <MudToolBar Dense WrapContent="true" Class="py-1 px-0">
                <MudButton Disabled="@_loading"
                           OnClick="@(() => ApplyFilters())"
                           StartIcon="@Icons.Material.Outlined.Refresh">
                    @AppStrings.Refresh
                </MudButton>

                <MudButton StartIcon="@Icons.Material.Outlined.Add"
                           OnClick="AddClick">
                    @AppStrings.New
                </MudButton>
            </MudToolBar>

        </MudStack>
    </ToolBarContent>
    <Columns>
        <HierarchyColumn T="ProductListItemDto" />
        <PropertyColumn Title="Nombre" Property="x=>x.Name" />
        <PropertyColumn Title="Stock" Property="x=>x.Stock" />
        <PropertyColumn Title="Stock Minimo" Property="x=>x.StockMin" />
        <PropertyColumn Title="Precio Costo" Property="x=>x.CostPrice" Format="C" />
        <PropertyColumn Title="Precio Venta" Property="x=>x.SalePrice" Format="C" />
        <PropertyColumn Title="Categoria" Property="x=>x.CategoryName" />
        <TemplateColumn HeaderStyle="white-space:nowrap;width:50px;" StickyRight="true" Resizable="false" Title="Acciones">
            <CellTemplate>
                <MudStack Row="true" Justify="Justify.Center">
                    <MudIconButton Size="@MudBlazor.Size.Small"
                                   Icon="@Icons.Material.Outlined.Search"
                                   Color="Color.Success"
                                   OnClick="()=>DetailClick(context.Item.Id)" />
                    <MudIconButton Size="@MudBlazor.Size.Small"
                                   Icon="@Icons.Material.Outlined.Edit"
                                   Color="Color.Primary"
                                   OnClick="()=>EditClick(context.Item.Id)" />
                    <MudIconButton Size="@MudBlazor.Size.Small"
                                   Icon="@Icons.Material.Outlined.Delete"
                                   Color="Color.Error"
                                   OnClick="()=>DeleteClick(context.Item)" />
                </MudStack>
            </CellTemplate>
        </TemplateColumn>
    </Columns>
    <ChildRowContent>
        <MudGrid>
            <MudItem xs="12" sm="12" md="12">
                <ReadOnlyField Value="@context.Item.Description" Label="Descripción"></ReadOnlyField>
            </MudItem>
            <MudItem xs="12" sm="6" md="4">
                <ReadOnlyField Value="@context.Item.CreatedAt" Label="Creado"></ReadOnlyField>
            </MudItem>
            <MudItem xs="12" sm="6" md="4">
                <ReadOnlyField Value="@context.Item.UpdatedAt" Label="Actualizado"></ReadOnlyField>
            </MudItem>

        </MudGrid>
    </ChildRowContent>
    <PagerContent>
        <MudDataGridPager T="ProductListItemDto" />
    </PagerContent>
    <NoRecordsContent>
        <MudText>No hay registros de <strong>Productos</strong></MudText>
    </NoRecordsContent>
</MudDataGrid>

@code {

    private List<BreadcrumbItem> _items = new List<BreadcrumbItem>
{
        new BreadcrumbItem("Products", href: null, icon: Icons.Material.Filled.Home,disabled: true),
    };
    private GetProductsQuery _filter = new GetProductsQuery();

    private DialogOptions _optionsDialogs = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
    private MudDataGrid<ProductListItemDto> dataGridRef = null!;
    private MudDateRangePicker? _picker;
    private DateRange _dateRange = new DateRange();
    private bool _filtersVisible = true;
    private bool _advancedSearchExpanded;
    private bool _loading = true;

    private async Task<GridData<ProductListItemDto>> GetTableData(GridState<ProductListItemDto> gridState)
    {
        try
        {
            _loading = true;
            _filter.Page = (gridState.Page + 1);

            if (_dateRange != null)
            {
                _filter.CreatedFrom = _dateRange.Start;
                _filter.CreatedTo = _dateRange.End;
            }
            else
            {
                _filter.CreatedFrom = null;
                _filter.CreatedTo = null;
            }
            _filter.SortColumn = nameof(ProductListItemDto.CreatedAt);
            _filter.SortDescending = true;
            _filter.PageSize = gridState.PageSize;
            var _sortDefinitions = gridState.SortDefinitions.FirstOrDefault();
            if (_sortDefinitions != null)
            {
                _filter.SortColumn = _sortDefinitions.SortBy;
                _filter.SortDescending = _sortDefinitions.Descending;
            }
            var paginatedList = await _queryMediator.QueryAsync(_filter);

            return new GridData<ProductListItemDto>() { TotalItems = (int)paginatedList.PagedInfo.TotalRecords, Items = paginatedList.Value };
        }        
        finally
        {
            _loading = false;
        }

    }

    private void AddClick()
    {
        _navManager.NavigateTo("." + PageRoute.NewProduct);
    }

    private void EditClick(Guid id)
    {
        _navManager.NavigateTo("." + PageRoute.EditProduct + $"/{id}", true);
    }

    private void DetailClick(Guid id)
    {
        _navManager.NavigateTo("." + PageRoute.DetailProduct + $"/{id}", true);
    }

    private async Task DeleteClick(ProductListItemDto item)
    {
        await _dialogService.ShowConfirmDialog($"¿Desea eliminar el Producto {item.Name}?", "Eliminar Producto ", async (e) =>
        {
            try
            {
                var result = await _commandMediator.SendAsync(new DeleteProductCommand
                {
                    ProductId = item.Id
                });
                if (result.IsSuccess)
                {
                    await dataGridRef.ReloadServerData();
                    _snackbarService.Add(result.SuccessMessage, MudBlazor.Severity.Success);
                }
                else
                {
                    _snackbarService.Add(result.Errors.FirstOrDefault() ?? "", MudBlazor.Severity.Error);
                }
            }
            catch (Exception ex)
            {
                _snackbarService.Add(ex.Message, MudBlazor.Severity.Normal);
            }
        });
    }

    private void ToggleFilters() => _filtersVisible = !_filtersVisible;

    private void ApplyFilters()
    {
        _filter.CreatedFrom = _dateRange.Start;
        _filter.CreatedTo = _dateRange.End;
        dataGridRef.ReloadServerData();
    }

    private void ClearFilters()
    {
        _filter = new GetProductsQuery();
        _dateRange = new DateRange();
        dataGridRef.ReloadServerData();
    }
}

